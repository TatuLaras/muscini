#include "analyze.h"
#include "fft.h"
#include <assert.h>
#include <math.h>
#include <stdio.h>
#include <string.h>

#define FORMAT ma_format_f32
#define CHANNELS 2
#define SAMPLE_RATE 48000

#define MAXIMUM_VALUE_DECAY_RATE 0.00002
#define SMOOTHING_AVERAGING_WINDOW 2
#define SMOOTH_REALTIME_WINDOW 12
#define BEAT_TRESHOLD 0.008

static float samples_l[INPUT_SIZE] = {0};
static size_t samples_l_used = 0;
static pthread_mutex_t lock;

static FFTTransformer *transformer = 0;

static ma_device device;

static const float frequency_values[FREQUENCY_COUNT] = {
    0.000000,     43.066406,    86.132812,    129.199219,   172.265625,
    215.332031,   258.398438,   301.464844,   344.531250,   387.597656,
    430.664062,   473.730469,   516.796875,   559.863281,   602.929688,
    645.996094,   689.062500,   732.128906,   775.195312,   818.261719,
    861.328125,   904.394531,   947.460938,   990.527344,   1033.593750,
    1076.660156,  1119.726562,  1162.792969,  1205.859375,  1248.925781,
    1291.992188,  1335.058594,  1378.125000,  1421.191406,  1464.257812,
    1507.324219,  1550.390625,  1593.457031,  1636.523438,  1679.589844,
    1722.656250,  1765.722656,  1808.789062,  1851.855469,  1894.921875,
    1937.988281,  1981.054688,  2024.121094,  2067.187500,  2110.253906,
    2153.320312,  2196.386719,  2239.453125,  2282.519531,  2325.585938,
    2368.652344,  2411.718750,  2454.785156,  2497.851562,  2540.917969,
    2583.984375,  2627.050781,  2670.117188,  2713.183594,  2756.250000,
    2799.316406,  2842.382812,  2885.449219,  2928.515625,  2971.582031,
    3014.648438,  3057.714844,  3100.781250,  3143.847656,  3186.914062,
    3229.980469,  3273.046875,  3316.113281,  3359.179688,  3402.246094,
    3445.312500,  3488.378906,  3531.445312,  3574.511719,  3617.578125,
    3660.644531,  3703.710938,  3746.777344,  3789.843750,  3832.910156,
    3875.976562,  3919.042969,  3962.109375,  4005.175781,  4048.242188,
    4091.308594,  4134.375000,  4177.441406,  4220.507812,  4263.574219,
    4306.640625,  4349.707031,  4392.773438,  4435.839844,  4478.906250,
    4521.972656,  4565.039062,  4608.105469,  4651.171875,  4694.238281,
    4737.304688,  4780.371094,  4823.437500,  4866.503906,  4909.570312,
    4952.636719,  4995.703125,  5038.769531,  5081.835938,  5124.902344,
    5167.968750,  5211.035156,  5254.101562,  5297.167969,  5340.234375,
    5383.300781,  5426.367188,  5469.433594,  5512.500000,  5555.566406,
    5598.632812,  5641.699219,  5684.765625,  5727.832031,  5770.898438,
    5813.964844,  5857.031250,  5900.097656,  5943.164062,  5986.230469,
    6029.296875,  6072.363281,  6115.429688,  6158.496094,  6201.562500,
    6244.628906,  6287.695312,  6330.761719,  6373.828125,  6416.894531,
    6459.960938,  6503.027344,  6546.093750,  6589.160156,  6632.226562,
    6675.292969,  6718.359375,  6761.425781,  6804.492188,  6847.558594,
    6890.625000,  6933.691406,  6976.757812,  7019.824219,  7062.890625,
    7105.957031,  7149.023438,  7192.089844,  7235.156250,  7278.222656,
    7321.289062,  7364.355469,  7407.421875,  7450.488281,  7493.554688,
    7536.621094,  7579.687500,  7622.753906,  7665.820312,  7708.886719,
    7751.953125,  7795.019531,  7838.085938,  7881.152344,  7924.218750,
    7967.285156,  8010.351562,  8053.417969,  8096.484375,  8139.550781,
    8182.617188,  8225.683594,  8268.750000,  8311.816406,  8354.882812,
    8397.949219,  8441.015625,  8484.082031,  8527.148438,  8570.214844,
    8613.281250,  8656.347656,  8699.414062,  8742.480469,  8785.546875,
    8828.613281,  8871.679688,  8914.746094,  8957.812500,  9000.878906,
    9043.945312,  9087.011719,  9130.078125,  9173.144531,  9216.210938,
    9259.277344,  9302.343750,  9345.410156,  9388.476562,  9431.542969,
    9474.609375,  9517.675781,  9560.742188,  9603.808594,  9646.875000,
    9689.941406,  9733.007812,  9776.074219,  9819.140625,  9862.207031,
    9905.273438,  9948.339844,  9991.406250,  10034.472656, 10077.539062,
    10120.605469, 10163.671875, 10206.738281, 10249.804688, 10292.871094,
    10335.937500, 10379.003906, 10422.070312, 10465.136719, 10508.203125,
    10551.269531, 10594.335938, 10637.402344, 10680.468750, 10723.535156,
    10766.601562, 10809.667969, 10852.734375, 10895.800781, 10938.867188,
    10981.933594, 11025.000000, 11068.066406, 11111.132812, 11154.199219,
    11197.265625, 11240.332031, 11283.398438, 11326.464844, 11369.531250,
    11412.597656, 11455.664062, 11498.730469, 11541.796875, 11584.863281,
    11627.929688, 11670.996094, 11714.062500, 11757.128906, 11800.195312,
    11843.261719, 11886.328125, 11929.394531, 11972.460938, 12015.527344,
    12058.593750, 12101.660156, 12144.726562, 12187.792969, 12230.859375,
    12273.925781, 12316.992188, 12360.058594, 12403.125000, 12446.191406,
    12489.257812, 12532.324219, 12575.390625, 12618.457031, 12661.523438,
    12704.589844, 12747.656250, 12790.722656, 12833.789062, 12876.855469,
    12919.921875, 12962.988281, 13006.054688, 13049.121094, 13092.187500,
    13135.253906, 13178.320312, 13221.386719, 13264.453125, 13307.519531,
    13350.585938, 13393.652344, 13436.718750, 13479.785156, 13522.851562,
    13565.917969, 13608.984375, 13652.050781, 13695.117188, 13738.183594,
    13781.250000, 13824.316406, 13867.382812, 13910.449219, 13953.515625,
    13996.582031, 14039.648438, 14082.714844, 14125.781250, 14168.847656,
    14211.914062, 14254.980469, 14298.046875, 14341.113281, 14384.179688,
    14427.246094, 14470.312500, 14513.378906, 14556.445312, 14599.511719,
    14642.578125, 14685.644531, 14728.710938, 14771.777344, 14814.843750,
    14857.910156, 14900.976562, 14944.042969, 14987.109375, 15030.175781,
    15073.242188, 15116.308594, 15159.375000, 15202.441406, 15245.507812,
    15288.574219, 15331.640625, 15374.707031, 15417.773438, 15460.839844,
    15503.906250, 15546.972656, 15590.039062, 15633.105469, 15676.171875,
    15719.238281, 15762.304688, 15805.371094, 15848.437500, 15891.503906,
    15934.570312, 15977.636719, 16020.703125, 16063.769531, 16106.835938,
    16149.902344, 16192.968750, 16236.035156, 16279.101562, 16322.167969,
    16365.234375, 16408.300781, 16451.367188, 16494.433594, 16537.500000,
    16580.566406, 16623.632812, 16666.699219, 16709.765625, 16752.832031,
    16795.898438, 16838.964844, 16882.031250, 16925.097656, 16968.164062,
    17011.230469, 17054.296875, 17097.363281, 17140.429688, 17183.496094,
    17226.562500, 17269.628906, 17312.695312, 17355.761719, 17398.828125,
    17441.894531, 17484.960938, 17528.027344, 17571.093750, 17614.160156,
    17657.226562, 17700.292969, 17743.359375, 17786.425781, 17829.492188,
    17872.558594, 17915.625000, 17958.691406, 18001.757812, 18044.824219,
    18087.890625, 18130.957031, 18174.023438, 18217.089844, 18260.156250,
    18303.222656, 18346.289062, 18389.355469, 18432.421875, 18475.488281,
    18518.554688, 18561.621094, 18604.687500, 18647.753906, 18690.820312,
    18733.886719, 18776.953125, 18820.019531, 18863.085938, 18906.152344,
    18949.218750, 18992.285156, 19035.351562, 19078.417969, 19121.484375,
    19164.550781, 19207.617188, 19250.683594, 19293.750000, 19336.816406,
    19379.882812, 19422.949219, 19466.015625, 19509.082031, 19552.148438,
    19595.214844, 19638.281250, 19681.347656, 19724.414062, 19767.480469,
    19810.546875, 19853.613281, 19896.679688, 19939.746094, 19982.812500,
    20025.878906, 20068.945312, 20112.011719, 20155.078125, 20198.144531,
    20241.210938, 20284.277344, 20327.343750, 20370.410156, 20413.476562,
    20456.542969, 20499.609375, 20542.675781, 20585.742188, 20628.808594,
    20671.875000, 20714.941406, 20758.007812, 20801.074219, 20844.140625,
    20887.207031, 20930.273438, 20973.339844, 21016.406250, 21059.472656,
    21102.539062, 21145.605469, 21188.671875, 21231.738281, 21274.804688,
    21317.871094, 21360.937500, 21404.003906, 21447.070312, 21490.136719,
    21533.203125, 21576.269531, 21619.335938, 21662.402344, 21705.468750,
    21748.535156, 21791.601562, 21834.667969, 21877.734375, 21920.800781,
    21963.867188, 22006.933594};

float analyze_get_frequency_value(size_t frequency_index) {
    if (frequency_index >= FREQUENCY_COUNT)
        return 0;
    return frequency_values[frequency_index];
}

static void data_callback(ma_device *pDevice, void *pOutput, const void *pInput,
                          ma_uint32 frameCount) {
    pthread_mutex_lock(&lock);

    float *frames = (float *)pInput;
    for (size_t i = 0; i < frameCount * 2; i += 2) {
        // printf("L: %f R: %f\n", frames[i], frames[i + 1]);
        samples_l[samples_l_used++ % INPUT_SIZE] = frames[i];
    }

    pthread_mutex_unlock(&lock);
}

int analyze_init(const ma_device_id *device_id) {
    ma_device_config deviceConfig =
        ma_device_config_init(ma_device_type_capture);
    deviceConfig.capture.format = FORMAT;
    deviceConfig.capture.channels = CHANNELS;
    deviceConfig.capture.pDeviceID = device_id;
    deviceConfig.sampleRate = SAMPLE_RATE;
    deviceConfig.dataCallback = data_callback;

    if (ma_device_init(0, &deviceConfig, &device) != MA_SUCCESS) {
        printf("Failed to initialize capture device.\n");
        return 1;
    }

    if (ma_device_start(&device) != MA_SUCCESS) {
        ma_device_uninit(&device);
        printf("Failed to start device.\n");
        return 1;
    }

    transformer = create_fft_transformer(INPUT_SIZE, FFT_SCALED_OUTPUT);
    assert(transformer);

    return 0;
}

void analyze_deinit(void) {
    free_fft_transformer(transformer);
    ma_device_uninit(&device);
}

// From fft.c
static inline float hanning(int i, int nn) {
    return (0.5 * (1.0 - cosf(2.0 * M_PI * (float)i / (float)(nn - 1))));
}

static inline void rolling_average(float *out_value, float new, float window) {
    *out_value = (*out_value) * (window - 1) / window + new / window;
}

void analyze_get_metrics(AudioMetrics *out_metrics) {
    assert(transformer);
    assert(out_metrics);

    pthread_mutex_lock(&lock);

    static float temp_buffer[INPUT_SIZE] = {0};

    // A slowly decaying maximum value to normalize frequency data
    static float maximum = 0;
    maximum -= MAXIMUM_VALUE_DECAY_RATE;
    if (maximum < 0.001)
        maximum = 0.001;

    // Copy data while applying windowing function
    for (size_t i = 0; i < INPUT_SIZE; i++)
        temp_buffer[i] = samples_l[i] * hanning(i, INPUT_SIZE);

    static float smooth_realtime_maximum = 0;
    static float rapid_realtime_maximum = 0;
    float realtime_maximum = 0;

    fft_forward(transformer, temp_buffer);

    for (size_t i = 0; i < FREQUENCY_COUNT; i++) {
        assert((i * 2 + 1) < INPUT_SIZE);

        float cos_comp = temp_buffer[i * 2];
        float sin_comp = temp_buffer[i * 2 + 1];
        float mag = sqrt((cos_comp * cos_comp) + (sin_comp * sin_comp));

        // Values get smoothed using a slim rolling average
        rolling_average(out_metrics->frequencies + i, (mag / maximum),
                        SMOOTHING_AVERAGING_WINDOW);

        if (maximum < mag)
            maximum = mag;
        if (i < 5 && realtime_maximum < mag)
            realtime_maximum = mag;
    }

    rolling_average(&smooth_realtime_maximum, realtime_maximum, 10);
    rolling_average(&rapid_realtime_maximum, realtime_maximum, 8);

    out_metrics->beat = ((rapid_realtime_maximum - smooth_realtime_maximum) /
                         maximum) > BEAT_TRESHOLD;

    pthread_mutex_unlock(&lock);
}
